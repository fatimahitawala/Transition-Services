import express from 'express';
import { DocumentsController } from './documents.controller';
import { DocumentsValidation } from './documents.validation';
import { validate } from '../../Common/Middlewares/validate';
import { catchAsync } from '../../Common/Middlewares/catchAsync';
import { AuthMiddleware } from '../../Common/Middlewares/AuthMiddleware';
import { welcomePackSingleUpload, templateSingleUpload } from '../../Common/Utils/upload';

const documentsController = new DocumentsController();
const documentsValidation = new DocumentsValidation();
const authMiddleware = new AuthMiddleware();

const router = express.Router();

// Template-based routes organized by templateType
// All routes require authentication
// 
// Route Organization by Template Type:
// - welcome-pack: Welcome pack documents (templateType: welcome-pack)
// - occupancytemplate/:templateType: Move-in and move-out templates (templateType: move-in, move-out)
// - email-recipients: Email recipient configurations (templateType: recipient-mail)
// - history: Unified history tracking for all template types
//
// Welcome Pack Routes (templateType: welcome-pack)
router.get('/welcome-pack', authMiddleware.auth(), validate(documentsValidation.getWelcomePackList), catchAsync(documentsController.getWelcomePackList));
router.post('/welcome-pack', authMiddleware.auth(), welcomePackSingleUpload, validate(documentsValidation.createWelcomePack), catchAsync(documentsController.createWelcomePack));
router.get('/welcome-pack/:id/download', authMiddleware.auth(), validate(documentsValidation.getWelcomePackById), catchAsync(documentsController.downloadWelcomePackFile));
router.get('/welcome-pack/:id', authMiddleware.auth(), validate(documentsValidation.getWelcomePackById), catchAsync(documentsController.getWelcomePackById));
router.put('/welcome-pack/:id', authMiddleware.auth(), welcomePackSingleUpload, validate(documentsValidation.updateWelcomePack), catchAsync(documentsController.updateWelcomePack));

// Welcome Kit PDF Generation Routes
router.post('/welcome-kit/generate', authMiddleware.auth(), validate(documentsValidation.generateWelcomeKit), catchAsync(documentsController.generateWelcomeKitPDF));
router.post('/welcome-kit/template/:id/generate', authMiddleware.auth(), validate(documentsValidation.generateWelcomeKitFromTemplate), catchAsync(documentsController.generateWelcomeKitPDFFromTemplate));

// Template Routes (templateType: move-in, move-out)
// All routes now use /occupancytemplate/:templateType pattern
router.get('/occupancytemplate/:templateType', authMiddleware.auth(), validate(documentsValidation.getTemplateList), catchAsync(documentsController.getTemplateList));
router.post('/occupancytemplate/:templateType', authMiddleware.auth(), templateSingleUpload, validate(documentsValidation.createTemplate), catchAsync(documentsController.createTemplate));
router.get('/occupancytemplate/:templateType/:id', authMiddleware.auth(), validate(documentsValidation.getTemplateById), catchAsync(documentsController.getTemplateById));
router.get('/occupancytemplate/:templateType/:id/download', authMiddleware.auth(), validate(documentsValidation.getTemplateById), catchAsync(documentsController.downloadTemplateFile));
router.put('/occupancytemplate/:templateType/:id', authMiddleware.auth(), templateSingleUpload, validate(documentsValidation.updateTemplate), catchAsync(documentsController.updateTemplate));
router.get('/occupancytemplate/:templateType/:id/history', authMiddleware.auth(), validate(documentsValidation.getTemplateById), catchAsync(documentsController.getTemplateHistory));

// Email Recipients Routes (templateType: recipient-mail)
router.get('/email-recipients', authMiddleware.auth(), validate(documentsValidation.getEmailRecipientsList), catchAsync(documentsController.getEmailRecipientsList));
router.post('/email-recipients', authMiddleware.auth(), validate(documentsValidation.createEmailRecipients), catchAsync(documentsController.createEmailRecipients));
router.put('/email-recipients/:id', authMiddleware.auth(), validate(documentsValidation.updateEmailRecipients), catchAsync(documentsController.updateEmailRecipients));
router.get('/email-recipients/:id/history', authMiddleware.auth(), validate(documentsValidation.getEmailRecipientsById), catchAsync(documentsController.getEmailRecipientsHistory));

// Unified History Route - handles all template types (move-in, move-out, welcome-pack, recipient-mail)
router.get('/history/:templateType/:id', authMiddleware.auth(), validate(documentsValidation.getUnifiedHistory), catchAsync(documentsController.getUnifiedHistory));

/**
 * @swagger
 * /documents/welcome-pack/{id}:
 *   put:
 *     summary: Update welcome pack
 *     description: Update welcome pack status and optionally upload a new file. File upload is optional for updates.
 *     tags: [Documents - Welcome Pack]
 *     security:
 *       - bearerAuth: []
 *     parameters:
 *       - in: path
 *         name: id
 *         required: true
 *         schema:
 *           type: integer
 *           minimum: 1
 *         description: Welcome pack ID to update
 *     requestBody:
 *       required: true
 *       content:
 *         multipart/form-data:
 *           schema:
 *             type: object
 *             properties:
 *               isActive:
 *                 type: string
 *                 enum: ['true', 'false']
 *                 description: Active status of the welcome pack (optional)
 *               welcomePackFile:
 *                 type: string
 *                 format: binary
 *                 description: Welcome pack file (PDF or HTML) - optional for updates
 *             example:
 *               isActive: "false"
 *               welcomePackFile: "(optional file upload)"
 *     responses:
 *       200:
 *         description: Welcome pack updated successfully
 *         content:
 *           application/json:
 *             schema:
 *               type: object
 *               properties:
 *                 status:
 *                   type: boolean
 *                   example: true
 *                 message:
 *                   type: string
 *                   example: "Welcome pack updated successfully"
 *                 code:
 *                   type: string
 *                   example: "SC004"
 *                 data:
 *                   $ref: '#/components/schemas/WelcomePack'
 *       400:
 *         $ref: '#/components/responses/BadRequest'
 *       401:
 *         $ref: '#/components/responses/Unauthorized'
 *       404:
 *         $ref: '#/components/responses/NotFound'
 *       500:
 *         $ref: '#/components/responses/ErrorResponse'
 */

// Welcome Kit PDF Generation Routes

/**
 * @swagger
 * /documents/welcome-kit/generate:
 *   post:
 *     summary: Generate Welcome Kit PDF with dynamic data
 *     description: Creates a professional Welcome Kit PDF document for new residents with customizable move-in timings and resident information
 *     tags: [Documents - Welcome Kit]
 *     security:
 *       - bearerAuth: []
 *     requestBody:
 *       required: true
 *       content:
 *         application/json:
 *           schema:
 *             $ref: '#/components/schemas/WelcomeKitData'
 *           examples:
 *             basic:
 *               summary: Basic request with required fields only
 *               value:
 *                 residentName: "ADI NEGRU"
 *                 unitNumber: "1003"
 *                 buildingName: "Creek Vistas Grande"
 *             complete:
 *               summary: Complete request with all fields
 *               value:
 *                 residentName: "ADI NEGRU"
 *                 unitNumber: "1003"
 *                 buildingName: "Creek Vistas Grande"
 *                 communityName: "Creek Vistas Grande"
 *                 masterCommunityName: "Sobha Hartland"
 *                 dateOfIssue: "29-06-2025"
 *                 moveInDate: "05-07-2025"
 *                 referenceNumber: "WK-6844"
 *                 contactNumber: "800 SOBHA (76242)"
 *                 moveInTimingsWeekdays: "9:00 AM - 6:00 PM"
 *                 moveInTimingsSundays: "10:00 AM - 4:00 PM"
 *             cus
                   SSUUMMMMAARRYY OOFF LLEESSSS CCOOMMMMAANNDDSS

      Commands marked with * may be preceded by a number, _N.
      Notes in parentheses indicate the behavior if _N is given.
      A key preceded by a caret indicates the Ctrl key; thus ^K is ctrl-K.

  h  H                 Display this help.
  q  :q  Q  :Q  ZZ     Exit.
 ---------------------------------------------------------------------------

                           MMOOVVIINNGG

  e  ^E  j  ^N  CR  *  Forward  one line   (or _N lines).
  y  ^Y  k  ^K  ^P  *  Backward one line   (or _N lines).
  ESC-j             *  Forward  one file line (or _N file lines).
  ESC-k             *  Backward one file line (or _N file lines).
  f  ^F  ^V  SPACE  *  Forward  one window (or _N lines).
  b  ^B  ESC-v      *  Backward one window (or _N lines).
  z                 *  Forward  one window (and set window to _N).
  w                 *  Backward one window (and set window to _N).
  ESC-SPACE         *  Forward  one window, but don't stop at end-of-file.
  ESC-b             *  Backward one window, but don't stop at beginning-of-file.
  d  ^D             *  Forward  one half-window (and set half-window to _N).
  u  ^U             *  Backward one half-window (and set half-window to _N).
  ESC-)  RightArrow *  Right one half screen width (or _N positions).
  ESC-(  LeftArrow  *  Left  one half screen width (or _N positions).
  ESC-}  ^RightArrow   Right to last column displayed.
  ESC-{  ^LeftArrow    Left  to first column.
  F                    Forward forever; like "tail -f".
  ESC-F                Like F but stop when search pattern is found.
  r  ^R  ^L            Repaint screen.
  R                    Repaint screen, discarding buffered input.
        ---------------------------------------------------
        Default "window" is the screen height.
        Default "half-window" is half of the screen height.
 ---------------------------------------------------------------------------

                          SSEEAARRCCHHIINNGG

  /_p_a_t_t_e_r_n          *  Search forward for (_N-th) matching line.
  ?_p_a_t_t_e_r_n          *  Search backward for (_N-th) matching line.
  n                 *  Repeat previous search (for _N-th occurrence).
  N                 *  Repeat previous search in reverse direction.
  ESC-n             *  Repeat previous search, spanning files.
  ESC-N             *  Repeat previous search, reverse dir. & spanning files.
  ^O^N  ^On         *  Search forward for (_N-th) OSC8 hyperlink.
